<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>META Ads & Sales Data Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #4f46e5;
            background: #f1f5f9;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .file-upload {
            text-align: center;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15);
        }
        
        .file-upload h3 {
            color: #334155;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .file-input:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(79, 70, 229, 0.4);
        }
        
        .upload-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .data-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .summary-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .summary-card h4 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .summary-info {
            color: #64748b;
            line-height: 1.6;
        }
        
        .chat-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        
        .chat-header {
            margin-bottom: 25px;
            text-align: center;
        }
        
        .chat-header h3 {
            color: #1e293b;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
        }
        
        .message.user {
            background: #4f46e5;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.assistant {
            background: #f1f5f9;
            color: #334155;
            border-left: 4px solid #4f46e5;
        }
        
        .message-content {
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        .chat-input-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            transition: border-color 0.3s ease;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .send-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #64748b;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
            margin: 15px 0;
        }
        
        .success-message {
            background: #f0fdf4;
            color: #166534;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #16a34a;
            margin: 15px 0;
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 15px;
            transition: all 0.3s ease;
        }
        
        .clear-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        @media (max-width: 768px) {
            .upload-grid, .data-summary {
                grid-template-columns: 1fr;
            }
            
            .chat-input-container {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 META Ads & Sales Analyzer</h1>
            <p>Upload your data and get AI-powered insights instantly</p>
        </div>
        
        <div class="main-content">
            <div class="upload-section">
                <h2 style="text-align: center; margin-bottom: 25px; color: #1e293b; font-size: 1.8em;">📂 Upload Your Data Files</h2>
                
                <div class="upload-grid">
                    <div class="file-upload">
                        <h3>📊 META Ads Data</h3>
                        <input type="file" id="meta-file" class="file-input" accept=".csv,.xlsx,.xls" />
                        <p style="margin-top: 10px; color: #64748b; font-size: 0.9em;">CSV or Excel format</p>
                    </div>
                    
                    <div class="file-upload">
                        <h3>💰 Sales Data</h3>
                        <input type="file" id="sales-file" class="file-input" accept=".csv,.xlsx,.xls" />
                        <p style="margin-top: 10px; color: #64748b; font-size: 0.9em;">CSV or Excel format</p>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button id="upload-btn" class="upload-btn">Upload & Analyze</button>
                    <button id="clear-data-btn" class="clear-btn" style="display: none;">Clear Data</button>
                </div>
                
                <div class="loading" id="upload-loading">
                    <div class="spinner"></div>
                    <p>Processing your files...</p>
                </div>
            </div>
            
            <div id="data-summary" style="display: none;">
                <h3 style="text-align: center; margin-bottom: 20px; color: #1e293b; font-size: 1.6em;">📋 Data Overview</h3>
                <div class="data-summary" id="summary-content">
                    <!-- Summary will be populated here -->
                </div>
            </div>
            
            <div class="chat-section" id="chat-section" style="display: none;">
                <div class="chat-header">
                    <h3>💬 Ask Questions About Your Data</h3>
                    <p style="color: #64748b;">Get insights powered by Claude AI</p>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="message assistant">
                        <div class="message-content">🎉 Perfect! Your data has been uploaded successfully. 

I'm your AI data analyst powered by Claude. You can now ask me ANY question about your META Ads and Sales data in natural language. Here are some examples:

💰 **Performance Questions:**
• "What's my overall ROAS and ROI?"
• "Which campaigns are performing best?"
• "What's my cost per acquisition?"

📊 **Data Analysis:**
• "Show me the correlation between ad spend and sales"
• "What are the trends over time?"
• "Which products/campaigns need optimization?"

🎯 **Strategic Insights:**
• "What should I focus on to improve performance?"
• "Which audiences are converting best?"
• "How can I optimize my budget allocation?"

❓ **Custom Questions:**
Ask me anything else about your data - I can analyze patterns, calculate metrics, identify opportunities, and provide actionable recommendations!

<strong>What would you like to know about your data?</strong></div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <textarea 
                        id="question-input" 
                        class="chat-input" 
                        placeholder="Ask me anything: 'What's my ROAS?', 'Which campaigns should I scale?', 'Show me performance trends'..."
                        rows="2"
                    ></textarea>
                    <button id="send-btn" class="send-btn">Ask Claude</button>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button id="quick-analysis-btn" class="upload-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 10px 25px; font-size: 14px;">
                        📊 Get Full Performance Analysis
                    </button>
                </div>
                
                <div class="loading" id="chat-loading">
                    <div class="spinner"></div>
                    <p>Analyzing your data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const uploadBtn = document.getElementById('upload-btn');
        const sendBtn = document.getElementById('send-btn');
        const metaFileInput = document.getElementById('meta-file');
        const salesFileInput = document.getElementById('sales-file');
        const questionInput = document.getElementById('question-input');
        const chatMessages = document.getElementById('chat-messages');
        const uploadLoading = document.getElementById('upload-loading');
        const chatLoading = document.getElementById('chat-loading');
        const dataSummary = document.getElementById('data-summary');
        const chatSection = document.getElementById('chat-section');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const quickAnalysisBtn = document.getElementById('quick-analysis-btn');

        // Upload functionality
        uploadBtn.addEventListener('click', async () => {
            const metaFile = metaFileInput.files[0];
            const salesFile = salesFileInput.files[0];

            if (!metaFile || !salesFile) {
                showError('Please select both META Ads and Sales files');
                return;
            }

            const formData = new FormData();
            formData.append('meta_ads_file', metaFile);
            formData.append('sales_file', salesFile);

            uploadBtn.disabled = true;
            uploadLoading.style.display = 'block';

            try {
                console.log('Starting upload...'); // Debug log
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response received:', response.status); // Debug log
                
                const data = await response.json();
                console.log('Data parsed:', data); // Debug log

                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed');
                }

                showSuccess('Files uploaded successfully!');
                displayDataSummary(data);
                chatSection.style.display = 'block';
                clearDataBtn.style.display = 'inline-block';

            } catch (error) {
                console.error('Upload error:', error); // Debug log
                showError(`Upload failed: ${error.message}`);
            } finally {
                uploadBtn.disabled = false;
                uploadLoading.style.display = 'none';
            }
        });

        // Send question functionality
        sendBtn.addEventListener('click', sendQuestion);
        quickAnalysisBtn.addEventListener('click', () => getDetailedAnalysis('performance_summary'));
        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuestion();
            }
        });

        async function sendQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            // Add user message
            addMessage(question, 'user');
            questionInput.value = '';

            sendBtn.disabled = true;
            chatLoading.style.display = 'block';

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }

                addMessage(data.answer, 'assistant');

            } catch (error) {
                addMessage(`Error: ${error.message}`, 'assistant');
            } finally {
                sendBtn.disabled = false;
                chatLoading.style.display = 'none';
            }
        }

        async function getDetailedAnalysis(analysisType) {
            addMessage("📊 Running comprehensive performance analysis...", 'user');
            
            sendBtn.disabled = true;
            quickAnalysisBtn.disabled = true;
            chatLoading.style.display = 'block';

            try {
                const response = await fetch('/detailed-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ analysis_type: analysisType })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }

                addMessage(data.analysis, 'assistant');

            } catch (error) {
                addMessage(`Error: ${error.message}`, 'assistant');
            } finally {
                sendBtn.disabled = false;
                quickAnalysisBtn.disabled = false;
                chatLoading.style.display = 'none';
            }
        }
        clearDataBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to clear all uploaded data?')) return;

            try {
                await fetch('/clear-data', { method: 'POST' });
                
                // Reset UI
                dataSummary.style.display = 'none';
                chatSection.style.display = 'none';
                clearDataBtn.style.display = 'none';
                chatMessages.innerHTML = '';
                metaFileInput.value = '';
                salesFileInput.value = '';
                
                showSuccess('Data cleared successfully!');
            } catch (error) {
                showError('Failed to clear data');
            }
        });

        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayDataSummary(data) {
            const summaryContent = document.getElementById('summary-content');
            
            summaryContent.innerHTML = `
                <div class="summary-card">
                    <h4>📊 META Ads Data</h4>
                    <div class="summary-info">
                        <p><strong>Rows:</strong> ${data.meta_summary.rows}</p>
                        <p><strong>Columns:</strong> ${data.meta_summary.columns}</p>
                        <p><strong>Fields:</strong> ${data.meta_summary.column_names.join(', ')}</p>
                    </div>
                </div>
                <div class="summary-card">
                    <h4>💰 Sales Data</h4>
                    <div class="summary-info">
                        <p><strong>Rows:</strong> ${data.sales_summary.rows}</p>
                        <p><strong>Columns:</strong> ${data.sales_summary.columns}</p>
                        <p><strong>Fields:</strong> ${data.sales_summary.column_names.join(', ')}</p>
                    </div>
                </div>
            `;
            
            dataSummary.style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.main-content').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.querySelector('.main-content').appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }
    </script>
</body>
</html>